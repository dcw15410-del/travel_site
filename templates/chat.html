{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>{{ room }} 채팅방</h2>
  <p>현지 시각: <strong>{{ room_times[room] }}</strong></p>
  <div id="chat-box" class="border p-3 mb-3" style="height:400px; overflow-y:scroll;">
    {% for msg in messages %}
      <div><strong>{{ msg.nickname }}:</strong> {{ msg.text }} <small class="text-muted">{{ msg.created_at.strftime("%H:%M:%S") }}</small></div>
    {% endfor %}
  </div>
  <form id="chat-form" class="d-flex">
    <input id="message" type="text" class="form-control me-2" placeholder="메시지를 입력하세요">
    <button class="btn btn-primary" type="submit">전송</button>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const socket = io();
  const room = "{{ room }}";
  const user = "{{ user.nickname }}";

  socket.emit('join', {room: room, user: user});

  const chatBox = document.getElementById("chat-box");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("message");

  socket.on('receive_message', function(data){
    const div = document.createElement("div");
    div.innerHTML = `<strong>${data.user}:</strong> ${data.msg} <small class="text-muted">${data.time}</small>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  form.addEventListener("submit", function(e){
    e.preventDefault();
    const msg = input.value;
    if(msg.trim() !== ""){
      socket.emit("send_message", {room: room, user: user, msg: msg});
      input.value = "";
    }
  });

  window.addEventListener("beforeunload", function(){
    socket.emit("leave", {room: room, user: user});
  });
</script>
{% endblock %}
