<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ room }} 채팅방 | 여행 커뮤니티</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 0;
        }
        header {
            background: #4A90E2;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 30px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #chat-box {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        .msg {
            margin: 6px 0;
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
        }
        .my-msg {
            background: #DCF8C6;
            align-self: flex-end;
        }
        .other-msg {
            background: #f1f0f0;
            align-self: flex-start;
        }
        #input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
        }
        #msg {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #bbb;
            font-size: 16px;
        }
        #send-btn {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 16px;
        }
        #send-btn:hover {
            background: #357ABD;
        }
        #user-list {
            background: #fafafa;
            border-top: 1px solid #eee;
            padding: 10px 15px;
            font-size: 14px;
            color: #333;
        }
        .system-msg {
            text-align: center;
            color: #777;
            font-size: 13px;
            margin: 6px 0;
        }
    </style>
</head>
<body>

<header>{{ room }} 채팅방</header>

<div id="chat-container">
    <div id="chat-box"></div>
    <div id="user-list">현재 접속자: <span id="users">-</span></div>

    <div id="input-area">
        <input id="msg" type="text" placeholder="메시지를 입력하세요..." onkeydown="if(event.key==='Enter') sendMsg()">
        <button id="send-btn" onclick="sendMsg()">보내기</button>
    </div>
</div>

<!-- ✅ Socket.IO v3.1.3 (Flask-SocketIO 5.x 호환 버전) -->
<script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
<script>
    const room = "{{ room }}";
    const socket = io({ transports: ["websocket", "polling"] });

    const chatBox = document.getElementById("chat-box");
    const msgInput = document.getElementById("msg");
    const usersSpan = document.getElementById("users");

    // ✅ 서버 연결 후 join 이벤트
    socket.on("connect", () => {
        console.log("✅ Socket connected:", socket.id);
        socket.emit("join", { room });
    });

    // ✅ 서버로부터 메시지 수신
    socket.on("receive_message", (data) => {
        addMessage(data.user, data.msg, data.time);
    });

    // ✅ 시스템 메시지
    socket.on("auth_required", (data) => {
        alert(data.msg);
        window.location.href = "/login";
    });

    // ✅ 채팅방 사용자 업데이트
    socket.on("room_users_update", (data) => {
        const users = data.lists[room] || [];
        usersSpan.textContent = users.length ? users.join(", ") : "없음";
    });

    // ✅ 메시지 전송
    function sendMsg() {
        const msg = msgInput.value.trim();
        if (msg === "") return;
        socket.emit("send_message", { room, msg });
        msgInput.value = "";
    }

    // ✅ 메시지 표시 함수
    function addMessage(user, msg, time) {
        const div = document.createElement("div");
        const nickname = "{{ current_user.nickname if current_user else '익명' }}";
        const isMine = (user === nickname);
        div.className = `msg ${isMine ? "my-msg" : "other-msg"}`;
        const safeMsg = msg.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        div.innerHTML = `<b>${user}</b> <small>${time || ""}</small><br>${safeMsg}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ✅ 브라우저 종료 시 leave 이벤트
    window.addEventListener("beforeunload", () => {
        socket.emit("leave", { room });
    });
</script>

</body>
</html>
