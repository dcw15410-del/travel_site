{% extends "base.html" %}
{% block content %}
<h2>{{ room }} 채팅방</h2>

<div id="room-info">
    현재 접속자: <b id="count-{{room}}">{{ room_users[room] }}</b>명 |
    현지 시각: <span id="time-{{room}}">{{ room_times[room] }}</span>
</div>

<div id="chat-box" style="border:1px solid #ccc; height:400px; overflow-y:auto;">
    {% for m in messages %}
        <div><b>{{ m.nickname }}</b>: {{ m.text }}</div>
    {% endfor %}
</div>

<form id="chat-form">
    <input type="text" id="msg" autocomplete="off" placeholder="메시지 입력">
    <button>전송</button>
</form>

<script>
const socket = io();
const room = "{{ room }}";

socket.emit("join", {room});

socket.on("receive_message", data => {
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.innerHTML = `<b>${data.user}</b>: ${data.msg}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
});

socket.on("room_users_update", data => {
    const count = data.counts[room];
    if (count !== undefined) {
        document.getElementById("count-" + room).textContent = count;
    }
});

socket.on("time_update", data => {
    const t = data[room];
    if (t) document.getElementById("time-" + room).textContent = t;
});

document.getElementById("chat-form").onsubmit = e => {
    e.preventDefault();
    const msg = document.getElementById("msg").value.trim();
    if (msg) socket.emit("send_message", {room, msg});
    document.getElementById("msg").value = "";
};
</script>
{% endblock %}
