{% extends "base.html" %}
{% block content %}
<h2>{{ room }} 채팅방</h2>
<div class="card">
  <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto; background: #fff;">
  </div>
</div>

<form id="chat-form" class="mt-3 d-flex">
  <input type="text" id="chat-input" class="form-control me-2" placeholder="메시지를 입력하세요">
  <button type="submit" class="btn btn-primary">전송</button>
</form>

<div class="mt-3">
  <h5>현재 접속자</h5>
  <ul id="user-list" class="list-group"></ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  const socket = io();
  const room = "{{ room }}";
  const user = "{{ user.nickname }}";
  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const userList = document.getElementById("user-list");

  // 입장
  socket.emit("join", {room: room, user: user});

  // 메시지 수신
  socket.on("receive_message", (data) => {
    const p = document.createElement("p");
    p.innerHTML = `<strong>[${data.time}] ${data.user}:</strong> ${data.msg}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // 메시지 전송
  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const msg = chatInput.value.trim();
    if(msg){
      socket.emit("send_message", {room: room, user: user, msg: msg});
      chatInput.value = "";
    }
  });

  // 사용자 목록 업데이트
  socket.on("room_users_update", (data) => {
    if(data.lists && data.lists[room]){
      userList.innerHTML = "";
      data.lists[room].forEach((nickname) => {
        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.textContent = nickname;
        userList.appendChild(li);
      });
    }
    if(data.counts && data.counts[room] !== undefined){
      const countSpan = document.getElementById("count-" + room);
      if(countSpan){
        countSpan.textContent = data.counts[room];
      }
    }
  });

  // 퇴장 시 알림
  window.addEventListener("beforeunload", () => {
    socket.emit("leave", {room: room, user: user});
  });
</script>
{% endblock %}
