{% extends "base.html" %}
{% block title %}{{ room }} 채팅방{% endblock %}

{% block content %}
<h2>{{ room }} 채팅방</h2>
<div class="chat-box" id="chat-box"></div>
<div class="chat-input">
  <form id="chat-form">
    <div class="input-group">
      <input type="text" id="message" class="form-control" placeholder="메시지를 입력하세요">
      <button class="btn btn-primary" type="submit">전송</button>
    </div>
  </form>
</div>
<div class="mt-3">
  <a href="{{ url_for('chat_rooms') }}" class="btn btn-secondary">채팅방 목록으로</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  const socket = io();
  const room = "{{ room }}";
  const nickname = "{{ user.nickname }}";

  // 방 입장
  socket.emit("join", {room: room, user: nickname});

  // 메시지 수신
  socket.on("receive_message", function(data){
    const box = $("#chat-box");
    const msg = `<div class="chat-message"><span class="user">${data.user}</span>: ${data.msg} <span class="time">[${data.time}]</span></div>`;
    box.append(msg);
    box.scrollTop(box[0].scrollHeight);
  });

  // 메시지 전송
  $("#chat-form").submit(function(e){
    e.preventDefault();
    const msg = $("#message").val().trim();
    if (!msg) return;
    socket.emit("send_message", {room: room, user: nickname, msg: msg});
    $("#message").val("");
  });

  // 방 나가기
  window.addEventListener("beforeunload", function(){
    socket.emit("leave", {room: room, user: nickname});
  });
</script>
{% endblock %}
