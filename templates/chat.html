{% extends "base.html" %}
{% block title %}{{ room }} 채팅{% endblock %}
{% block head %}
<script>
    const socket = io();
    const room = "{{ room }}";
    const user = "{{ user.nickname if user else '익명' }}";
    window.onload = () => {
        socket.emit('join', {room, user});
        const form = document.getElementById('chat-form');
        form.onsubmit = (e) => {
            e.preventDefault();
            const msgInput = document.getElementById('msg');
            if(msgInput.value.trim() === '') return;
            socket.emit('send_message', {room, msg: msgInput.value, user});
            msgInput.value = '';
        }
    }

    socket.on('receive_message', data => {
        const chat = document.getElementById('chat-box');
        const msg = document.createElement('div');
        msg.textContent = `[${data.time}] ${data.user}: ${data.msg}`;
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
    });

    socket.on('room_users_update', data => {
        document.getElementById('user-count').textContent = data[room] || 0;
    });

    window.onbeforeunload = () => {
        socket.emit('leave', {room, user});
    }
</script>
{% endblock %}
{% block content %}
<h2>{{ room }} 채팅</h2>
<p>현재 접속 인원: <span id="user-count">{{ room_users[room] }}</span></p>
<div id="chat-box" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:5px;">
    {% for msg in messages %}
    <div>[{{ msg.created_at.strftime("%H:%M:%S") }}] {{ msg.nickname }}: {{ msg.text }}</div>
    {% endfor %}
</div>
<form id="chat-form">
    <input type="text" id="msg" placeholder="메시지 입력" autocomplete="off">
    <button type="submit">전송</button>
</form>
<button onclick="history.back()">돌아가기</button>
{% endblock %}
