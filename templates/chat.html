<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ room }} 채팅방</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <h2>{{ room }} 채팅방</h2>
    <p>접속 인원: <span id="user-count">{{ room_users[room] }}</span>명</p>
    <p>현재 시각: <span id="room-time">{{ room_times[room] }}</span></p>

    <div id="chat-box" style="border:1px solid #ccc; height:300px; overflow-y:scroll; margin-bottom:10px; padding:5px;">
        {% for m in messages %}
        <div><b>{{ m.nickname }}</b> [{{ m.created_at.strftime("%H:%M:%S") }}]: {{ m.text }}</div>
        {% endfor %}
    </div>

    <input type="text" id="msg" placeholder="메시지를 입력하세요" style="width:70%;">
    <button onclick="sendMessage()">보내기</button>

    <script>
        const socket = io();
        const room = "{{ room }}";
        const nickname = "{{ user.nickname }}";

        // 채팅방 입장
        socket.emit("join", {room: room, user: nickname});

        // 메시지 수신
        socket.on("receive_message", function(data) {
            let chatBox = document.getElementById("chat-box");
            let div = document.createElement("div");
            div.innerHTML = "<b>" + data.user + "</b> [" + data.time + "]: " + data.msg;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // 인원수 업데이트
        socket.on("room_users_update", function(data) {
            if (room in data) {
                document.getElementById("user-count").innerText = data[room];
            }
        });

        // 메시지 전송
        function sendMessage() {
            let msg = document.getElementById("msg").value;
            if (msg.trim() === "") return;
            socket.emit("send_message", {room: room, user: nickname, msg: msg});
            document.getElementById("msg").value = "";
        }

        // 퇴장 시 leave 이벤트
        window.addEventListener("beforeunload", function() {
            socket.emit("leave", {room: room, user: nickname});
        });

        // 실시간 시각 갱신
        const timezones = {
            "한국": "Asia/Seoul",
            "일본": "Asia/Tokyo",
            "베트남": "Asia/Ho_Chi_Minh",
            "필리핀": "Asia/Manila",
            "태국": "Asia/Bangkok"
        };

        function updateRoomTime() {
            const now = new Date();
            try {
                let tz = new Intl.DateTimeFormat("ko-KR", {
                    timeZone: timezones[room],
                    hour: "2-digit", minute: "2-digit", second: "2-digit"
                }).format(now);
                document.getElementById("room-time").innerText = tz;
            } catch(e) {
                console.error("시간 변환 오류:", e);
            }
        }
        setInterval(updateRoomTime, 1000);
        updateRoomTime();
    </script>
</body>
</html>
