{% extends "base.html" %}
{% block title %}{{ room }} 채팅방{% endblock %}
{% block content %}
<h2>{{ room }} 채팅방</h2>
<div class="row">
  <!-- 메시지 영역 -->
  <div class="col-md-8">
    <div class="chat-box mb-3" id="chat-box"></div>
    <form id="chat-form" class="d-flex">
      <input type="text" id="msg" class="form-control me-2" placeholder="메시지를 입력하세요">
      <button type="submit" class="btn btn-primary">전송</button>
    </form>
  </div>

  <!-- 접속자 목록 + 시간 -->
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>현재 접속자 (<span id="count">{{ room_users[room] }}</span>명)</h5>
        <ul id="user-list" class="list-group mb-3">
          {% for nickname in room_user_list[room] %}
          <li class="list-group-item">{{ nickname }}</li>
          {% endfor %}
        </ul>
        <p>현지 시각: <span id="local-time">{{ room_times[room] }}</span></p>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();
const room = "{{ room }}";
const nickname = "{{ user.nickname }}";

// 메시지 전송
document.getElementById("chat-form").addEventListener("submit", function(e) {
  e.preventDefault();
  const msg = document.getElementById("msg").value;
  if (msg.trim() !== "") {
    socket.emit("send_message", {room: room, msg: msg, user: nickname});
    document.getElementById("msg").value = "";
  }
});

// 메시지 수신
socket.on("receive_message", function(data) {
  const box = document.getElementById("chat-box");
  const div = document.createElement("div");
  div.textContent = `[${data.time}] ${data.user}: ${data.msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
});

// 유저수 & 목록 갱신
socket.on("room_users_update", function(data) {
  const counts = data.counts || {};
  const lists = data.lists || {};
  if (counts[room] !== undefined) {
    document.getElementById("count").textContent = counts[room];
  }
  if (lists[room] !== undefined) {
    const ul = document.getElementById("user-list");
    ul.innerHTML = "";
    lists[room].forEach(user => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.textContent = user;
      ul.appendChild(li);
    });
  }
});

// 방 입장/퇴장
socket.emit("join", {room: room, user: nickname});
window.addEventListener("beforeunload", () => {
  socket.emit("leave", {room: room, user: nickname});
});

// 현지 시각 실시간 반영
function updateLocalTime() {
  const el = document.getElementById("local-time");
  if (el) {
    const now = new Date();
    el.textContent = now.toLocaleTimeString("ko-KR", { hour12: false });
  }
}
setInterval(updateLocalTime, 1000);
</script>
{% endblock %}
