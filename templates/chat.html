{% extends "base.html" %}
{% block title %}{{ room }} 채팅방 - TravelSite{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>{{ room }} 채팅방</h2>
    <div id="chat-box" class="border rounded p-3 mb-3 bg-white" style="height:400px; overflow-y:auto;">
        <!-- 채팅 메시지는 JS로만 표시 -->
    </div>
    <form id="chat-form">
        <div class="input-group">
            <input type="text" id="chat-input" class="form-control" placeholder="메시지를 입력하세요">
            <button type="submit" class="btn btn-primary">보내기</button>
        </div>
    </form>
</div>

{% block extra_script %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
const socket = io();
const chatBox = document.getElementById("chat-box");
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");

const room = "{{ room }}";
const user = "{{ user.nickname }}";

socket.emit("join", {room: room, user: user});

// 메시지 받기
socket.on("receive_message", data => {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${data.user}</strong>: ${data.msg} <span class="text-muted" style="font-size:0.8em;">(${data.time})</span>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
});

// 메시지 보내기
chatForm.addEventListener("submit", e => {
    e.preventDefault();
    if(chatInput.value.trim() !== ""){
        socket.emit("send_message", {room: room, user: user, msg: chatInput.value});
        chatInput.value = "";
    }
});

// 페이지 떠날 때 퇴장 알림
window.addEventListener("beforeunload", () => {
    socket.emit("leave", {room: room, user: user});
});
</script>
{% endblock %}
{% endblock %}
