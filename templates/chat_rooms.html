{% extends "base.html" %}
{% block title %}채팅방 목록 - TravelSite{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-primary text-white">
    채팅방 목록
  </div>
  <div class="card-body">
    <div class="list-group">
      {% for r in chat_rooms %}
        <a href="{{ url_for('chat', room=r) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ r }}</strong><br>
            <small>현지시각: <span class="local-time" data-room="{{ r }}" data-tz="{{ timezone_map[r] }}">{{ room_times[r] }}</span></small>
          </div>
          <span class="badge bg-primary rounded-pill" id="user-count-{{ r }}">{{ room_users[r] }}</span>
        </a>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  // ✅ 인원수 실시간 업데이트
  socket.on("room_users_update", (data) => {
    for (const [room, count] of Object.entries(data)) {
      const el = document.getElementById(`user-count-${room}`);
      if (el) el.innerText = count;
    }
  });

  // ✅ 현지시각 실시간 업데이트
  function updateTimes() {
    document.querySelectorAll(".local-time").forEach(el => {
      const tz = el.dataset.tz;
      el.innerText = new Date().toLocaleTimeString("ko-KR", { timeZone: tz, hour12: false });
    });
  }
  setInterval(updateTimes, 1000);
  updateTimes();
</script>
{% endblock %}
