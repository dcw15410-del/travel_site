{% extends "base.html" %}
{% block content %}
<h3>{{ room }} 채팅방</h3>
<p>현지 시각: {{ local_time }}</p>
<div id="chat-box" class="border p-3 mb-3" style="height:300px;overflow-y:scroll;"></div>
<input id="msg" class="form-control mb-2" placeholder="메시지를 입력하세요">
<button id="send" class="btn btn-primary w-100">전송</button>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
    const socket = io();
    const username = "{{ session['username'] }}";
    const room = "{{ room }}";

    socket.emit("join", {username, room});

    socket.on("message", data => {
        const box = document.getElementById("chat-box");
        box.innerHTML += `<div>${data.msg}</div>`;
        box.scrollTop = box.scrollHeight;
    });

    socket.on("user_count", data => {
        document.title = `접속자 수: ${data.count}`;
    });

    document.getElementById("send").onclick = () => {
        const msg = document.getElementById("msg").value;
        socket.emit("message", {username, msg, room});
        document.getElementById("msg").value = "";
    };

    window.onbeforeunload = () => {
        socket.emit("leave", {username, room});
    };
</script>
{% endblock %}
