{% extends "base.html" %}

{% block title %}채팅방{% endblock %}

{% block content %}
<h2>채팅방</h2>

<div class="mb-3">
    <label for="room" class="form-label">채팅방 이름</label>
    <input type="text" id="room" class="form-control" placeholder="채팅방 이름 입력">
    <button id="joinBtn" class="btn btn-primary mt-2">입장</button>
</div>

<div id="chat" class="border p-3 mb-3" style="height:300px; overflow-y:scroll;"></div>

<input type="text" id="msgInput" class="form-control" placeholder="메시지 입력">
<button id="sendBtn" class="btn btn-success mt-2">전송</button>

<script>
const socket = io();
let currentRoom = '';
let username = "{{ session['user'] if 'user' in session else '익명' }}";

document.getElementById('joinBtn').onclick = () => {
    const roomInput = document.getElementById('room').value;
    if(roomInput) {
        if(currentRoom) socket.emit('leave', {username, room: currentRoom});
        currentRoom = roomInput;
        socket.emit('join', {username, room: currentRoom});
        document.getElementById('chat').innerHTML = '';
    }
};

document.getElementById('sendBtn').onclick = () => {
    const msg = document.getElementById('msgInput').value;
    if(msg && currentRoom) {
        socket.emit('message', {username, room: currentRoom, message: msg});
        document.getElementById('msgInput').value = '';
    }
};

socket.on('message', data => {
    const chat = document.getElementById('chat');
    chat.innerHTML += `<p><strong>${data.username}:</strong> ${data.message}</p>`;
    chat.scrollTop = chat.scrollHeight;
});

socket.on('status', data => {
    const chat = document.getElementById('chat');
    chat.innerHTML += `<p><em>${data.msg}</em></p>`;
    chat.scrollTop = chat.scrollHeight;
});
</script>
{% endblock %}
